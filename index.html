<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geoportal Predial ‚Äî Vista simple</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --brand:#0f172a; --accent:#0ea5e9; --accent-dark:#0369a1;
      --panel-bg:#f8fafc; --card:#ffffff; --line:#e2e8f0;
      --predio:#0ea5e9; --comunidad:#22c55e; --otros:#a855f7; --highlight:#e11d48;
      --social:#f59e0b;
      --text:#0f172a;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;overflow:hidden;color:var(--text)}
    body{display:flex;flex-direction:column;height:100%}
    header{
      display:flex;align-items:center;gap:12px;flex-wrap:nowrap;
      padding:10px 14px;background:var(--brand);color:#fff;position:relative;z-index:9000;
      box-shadow:0 2px 10px rgba(0,0,0,.25);
      overflow-x:auto;flex-shrink:0;
    }
    header > *{flex:0 0 auto;min-width:0}
    header{scrollbar-width:thin}
    header::-webkit-scrollbar{height:4px}
    header::-webkit-scrollbar-thumb{background:rgba(255,255,255,.35);border-radius:999px}
    header .title{font-weight:700;letter-spacing:.3px;white-space:nowrap}
    #centerControls{flex:1 1 360px;display:flex;justify-content:center;position:relative;min-width:220px}
    #searchWrap{position:relative;width:100%;max-width:560px;min-width:200px;z-index:9500}
    #searchBox{
      width:100%;padding:10px 14px;border-radius:24px;border:none;outline:none;
      font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.15) inset, 0 1px 0 rgba(255,255,255,.1);
      color:var(--text);
    }
    #suggestions{
      position:absolute;left:0;right:0;top:44px;background:#fff;
      border:1px solid var(--line);border-radius:10px;z-index:9600;
      max-height:260px;overflow:auto;display:none;color:var(--text);
      box-shadow:0 12px 32px rgba(15,23,42,.25);
    }
    #suggestions.active{display:block}
    #suggestions div{padding:8px 10px;cursor:pointer}
    #suggestions div:hover{background:#f1f5f9}

    #rightControls{
      display:flex;align-items:center;gap:8px;
      flex-wrap:nowrap;
    }
    #rightControls select,#rightControls button{flex:0 0 auto;white-space:nowrap}
    select,button{padding:8px 10px;border-radius:8px;border:1px solid transparent;font-size:14px;min-width:0}
    select{background:#fff;border-color:var(--line);color:var(--text)}
    .btn{background:var(--accent);color:#fff;cursor:pointer}
    .btn:hover{background:var(--accent-dark)}
    .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.35)}
    .ghost:hover{border-color:#fff}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;min-width:40px;padding:8px;border-radius:8px;font-size:18px;line-height:1}

    /* Layout PC por defecto */
    #split{display:flex;flex:1;min-height:300px;position:relative}
    #leftPane{flex:1 1 50%;position:relative;background:#000;z-index:0}
    #rightPane{flex:1 1 50%;background:var(--panel-bg);border-left:1px solid var(--line);overflow:auto}
    #gutter{width:6px;cursor:col-resize;background:linear-gradient(90deg,transparent,rgba(0,0,0,.08),transparent)}
    #map{position:absolute;inset:0}

    /* M√≥vil: 50% mapa / 50% datos */
    @media (max-width: 900px){
      header{padding:8px 10px;gap:10px}
      .title{font-size:15px}
      #centerControls{min-width:200px;flex:1 1 300px}
      #searchWrap{min-width:180px}
      #searchBox{font-size:13px;padding:8px 12px}
      #rightControls{gap:7px}
      #split{flex-direction:column}
      #leftPane{flex-basis:auto;height:50vh}
      #rightPane{height:50vh;border-left:none;border-top:1px solid var(--line)}
      #gutter{display:none}
    }

    @media (max-width: 720px){
      header{gap:8px}
      #centerControls{min-width:170px;flex:1 1 240px}
      #searchWrap{min-width:160px}
      select,button{font-size:13px}
      .icon-btn{min-width:36px;padding:6px;font-size:16px}
      #rightControls{gap:6px}
    }

    @media (max-width: 520px){
      header{gap:6px}
      .title{font-size:14px}
      #centerControls{min-width:140px;flex:1 1 200px}
      #searchWrap{min-width:140px}
      #searchBox{padding:7px 10px;font-size:12px}
      .icon-btn{min-width:34px;padding:6px;font-size:15px}
    }

    .leaflet-control.mobile-quick{display:none!important}

    .modal-back{
      position:fixed;inset:0;background:rgba(15,23,42,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:7000;
    }
    .modal{
      background:#fff;color:var(--text);border-radius:14px;box-shadow:0 12px 40px rgba(15,23,42,.35);max-width:min(900px,96vw);width:100%;padding:20px;display:flex;flex-direction:column;gap:16px;
    }
    .modal .row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end}
    .modal label{display:flex;flex-direction:column;gap:4px;font-size:14px}
    .modal label input,.modal label select{margin-top:4px}
    .modal table{width:100%;border-collapse:collapse}
    .modal th,.modal td{border:1px solid var(--line);padding:8px;font-size:14px;text-align:left}
    .modal table.list th,.modal table.list td{font-size:10px}
    .modal thead{background:#f1f5f9;position:sticky;top:0;z-index:1}
    .modal-back.show{display:flex}

    @media (max-width: 600px){
      .modal .row{flex-direction:column;align-items:stretch}
      .modal .row > *{width:100%}
    }

    .panel{padding:16px}
    h3{margin:8px 0 12px;color:var(--accent-dark)}
    .block{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .label{font-weight:700;margin-bottom:4px}
    .textblock{white-space:pre-line;background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px}
    .area-card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0;transition: box-shadow .2s, background .2s, border-left-color .2s}
    .area-card h4{margin:0 0 6px;color:var(--accent)}
    .area-card.has-social{border-left:6px solid var(--social); background:#fff8eb}
    .area-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .pill:hover{border-color:var(--accent)}
    .muted{color:#64748b;font-size:12px}
    .badge{background:#eef2ff;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px}
    input,textarea{width:100%;padding:6px;border:1px solid var(--line);border-radius:8px;color:var(--text)}
    .btn-small{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn-small:hover{border-color:var(--accent)}
    td.clickable{cursor:pointer;text-decoration:underline}

    /* Bot√≥n Ubicaci√≥n (abajo-izquierda) */
    .map-btns{
      position:absolute; left:10px; bottom:10px; z-index:4500; display:flex; flex-direction:row; gap:8px; flex-wrap:wrap;
    }
    .map-btn{
      background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15)
    }
    .map-btn:hover{border-color:var(--accent)}

    .flash { animation: flash 1s ease-out 1; }
    @keyframes flash { 0% { box-shadow:0 0 0 rgba(14,165,233,0); background:#fff; }
      20%{ box-shadow:0 0 0 6px rgba(14,165,233,.15); background:#e0f2fe; }
      100%{ box-shadow:0 0 0 rgba(14,165,233,0); background:#fff; } }
  </style>
</head>
<body>
  <header>
    <div class="title">Geoportal Predial</div>

    <div id="centerControls">
      <div id="searchWrap">
        <input id="searchBox" type="text" placeholder="üîç Buscar cod_prel, cod_mtc, titular o prog_ini‚Ä¶" autocomplete="off" />
        <div id="suggestions"></div>
      </div>
    </div>

    <div id="rightControls">
      <button class="ghost icon-btn" id="btnLista" aria-label="Lista por comunidad" title="Lista por comunidad">üìã</button>
      <button class="ghost icon-btn" id="btnObs" aria-label="Observados" title="Observados">üëÅÔ∏è</button>
    </div>
  </header>

  <div id="split">
    <section id="leftPane">
      <div id="map"></div>
      <div class="map-btns"><button id="btnLocate" class="map-btn" title="Ubicarme">üìç</button></div>
    </section>

    <div id="gutter" title="Arrastra para redimensionar"></div>

    <section id="rightPane">
      <div class="panel">
        <h3>Detalle del predio</h3>
        <div id="commonBlock" class="block" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <div class="label">Datos:</div>
              <span id="unionCount" class="badge"></span>
            </div>
          </div>
          <div class="grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div><div class="label">C√≥digo MTC</div><div id="cm_mtc" class="textblock"></div></div>
            <div><div class="label">Comunidad</div><div id="cm_comunidad" class="textblock"></div></div>
            <div style="grid-column:1/-1"><div class="label">Titular</div><div id="cm_titular" class="textblock"></div></div>
            <div style="grid-column:1/-1"><div class="label">DNI / RUC</div><div id="cm_dni" class="textblock"></div></div>
            <div style="grid-column:1/-1"><div class="label">Contacto</div><div id="cm_contacto" class="textblock"></div></div>
            <div><div class="label">Condici√≥n</div><div id="cm_condicion" class="textblock"></div></div>
            <div><div class="label">Tipo</div><div id="cm_tipo" class="textblock"></div></div>
            <div><div class="label">Grupo</div><div id="cm_grupo" class="textblock"></div></div>
          </div>
        </div>

        <div id="areasWrap" class="block" style="display:none">
          <div class="label">√Åreas afectadas</div>
          <div id="areasList"></div>
        </div>

        <div id="emptyHint" class="muted">Selecciona un pol√≠gono o busca por c√≥digo/titular/prog_ini.</div>
      </div>
    </section>
  </div>

  <!-- Modal: Lista por Comunidad -->
  <div id="modalListBack" class="modal-back">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">Lista por comunidad</h3>
        <button class="btn-small" id="btnCloseList">‚úï</button>
      </div>
      <div class="row">
        <label>Comunidad:
          <select id="listComunidad" style="min-width:260px"></select>
        </label>
        <label>Filtrar texto:
          <input id="listFilter" type="text" placeholder="Filtrar por MTC, cod_prel, titular o prog_ini‚Ä¶" style="min-width:260px">
        </label>
        <button class="btn" id="btnLoadList">Cargar</button>
        <button class="btn-small" id="btnExportList" title="Exportar a Excel">üìÑ</button>
      </div>
      <div style="max-height:60vh;overflow:auto">
        <table class="list" id="tblList">
          <thead>
            <tr>
              <th>Comunidad</th>
              <th>C√≥digo MTC</th>
              <th>cod_prel</th>
              <th>Titular</th>
              <th>prog_ini</th>
              <th>Seleccionar</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="6" class="muted">Selecciona comunidad y pulsa ‚ÄúCargar‚Äù.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal: Observados -->
  <div id="modalObsBack" class="modal-back">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">C√≥digos observados</h3>
        <button class="btn-small" id="btnCloseObs">‚úï</button>
      </div>
      <div class="row">
        <label>Filtrar texto:
          <input id="obsFilter" type="text" placeholder="Filtrar por comunidad, MTC, cod_prel, titular o prog_ini‚Ä¶" style="min-width:260px">
        </label>
        <button class="btn" id="btnReloadObs">Recargar</button>
        <button class="btn-small" id="btnExportObsXls" title="Exportar a Excel">üìÑ</button>
        <button class="btn-small" id="btnExportObsKml" title="Exportar a KML">üó∫Ô∏è</button>
      </div>
      <div style="max-height:60vh;overflow:auto">
        <table class="list" id="tblObs">
          <thead>
            <tr>
              <th>Comunidad</th>
              <th>C√≥digo MTC</th>
              <th>cod_prel</th>
              <th>Titular</th>
              <th>prog_ini</th>
              <th>Observaci√≥n</th>
              <th>Seleccionar</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="7" class="muted">Cargando‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/** ====== CONFIG ====== **/
const SUPABASE_URL = "https://wbzxbfqowlfmmkwqeyam.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndienhiZnFvd2xmbW1rd3FleWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwMDQsImV4cCI6MjA3MjU2MTAwNH0.mJJ7yID73tUerWE_aiNw3ZE4o-Q9YrT39YN-iS2CksA";
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** ====== HELPERS ====== **/
function getVar(n){ return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }
function isPredios(v){ return (v||"").toLowerCase()==="predios" || (v||"").toLowerCase()==="predio"; }
function isComunidad(v){ return (v||"").toLowerCase()==="comunidad"; }
function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]||m)); }
function hasSocial(p){ return !!(p?.comentario_social && String(p.comentario_social).trim().length>0); }

const PREDIOS_CACHE_KEY = "prediosCache.v1";
const PREDIOS_CACHE_TTL = 1000 * 60 * 30; // 30 minutos

let cachedPredios = [];
let cachedPrediosMap = new Map();
let lastListRows = [];
let lastObsRows = [];
let initialFitCompleted = false;

/** ====== MAPA (zoom por defecto 13) ====== **/
const map = L.map('map', { zoomControl:true, attributionControl:false }).setView([-15.5, -70.1], 13);
L.control.attribution({ prefix:false }).addTo(map);
L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom:21, attribution:'¬© Google' }).addTo(map);

const baseStyle    = { color:getVar('--predio'),    weight:2, fillOpacity:0.20 };
const commStyle    = { color:getVar('--comunidad'), weight:2, fillOpacity:0.20 };
const otherStyle   = { color:getVar('--otros'),     weight:2, fillOpacity:0.20 };
const hiStyle      = { color:getVar('--highlight'), weight:3, fillOpacity:0.35 };
const socialStyle  = { color:getVar('--social'),    weight:3, fillOpacity:0.30 };
const viaStyle     = { color:'#f97316',             weight:3, dashArray:'8 4', fillOpacity:0 };

function styleByProps(p){
  if(hasSocial(p)) return socialStyle;
  if(isComunidad(p.tipo)) return commStyle;
  if(isPredios(p.tipo)) return baseStyle;
  return otherStyle;
}

let selectedCodPrel = null;
let currentUnirId = null;

const capaPredio    = L.geoJSON(null, { style: f=>styleByProps(f.properties) }).addTo(map);
const capaComunidad = L.geoJSON(null, { style: f=>styleByProps(f.properties) });
const capaOtros     = L.geoJSON(null, { style: f=>styleByProps(f.properties) }).addTo(map);

/* Capas (control) */
const overlayLayers = { "Predios":capaPredio, "Comunidades":capaComunidad, "Otros":capaOtros };
const layersCtl = L.control.layers(null, overlayLayers).addTo(map);

const externalScriptCache = new Map();

function ensureScriptLoaded(path){
  if(externalScriptCache.has(path)) return externalScriptCache.get(path);
  const promise = new Promise((resolve, reject)=>{
    const script = document.createElement("script");
    script.src = path;
    script.async = true;
    script.onload = ()=> resolve();
    script.onerror = ()=> reject(new Error(`No se pudo cargar ${path}`));
    document.head.appendChild(script);
  });
  externalScriptCache.set(path, promise);
  return promise;
}

function isLeafletLayer(value){
  return !!(value && typeof value.addTo === "function" && typeof value.remove === "function");
}

function unwrapModule(value, depth=0){
  if(!value || depth>3) return value;
  if(value.default) return unwrapModule(value.default, depth+1);
  return value;
}

function looksLikeGeoJSON(value){
  if(!value) return false;
  if(Array.isArray(value)){
    return value.every(item=> item && typeof item === "object" && (item.type || item.geometry));
  }
  if(typeof value !== "object") return false;
  if(Array.isArray(value.features)) return true;
  const type = value.type;
  return type === "FeatureCollection" || type === "Feature" || type === "GeometryCollection";
}

async function loadExternalGeoJSON(path, keys){
  try{
    await ensureScriptLoaded(path);
    for(const key of keys){
      const raw = window[key];
      if(!raw) continue;
      const data = unwrapModule(raw);
      if(isLeafletLayer(data)) return { kind:"layer", value:data };
      if(looksLikeGeoJSON(data)) return { kind:"data", value:data };
      if(data?.data && looksLikeGeoJSON(data.data)) return { kind:"data", value:data.data };
      if(data?.layer && isLeafletLayer(data.layer)) return { kind:"layer", value:data.layer };
    }
    console.warn(`No se encontr√≥ ninguna variable (${keys.join(", ")}) en ${path}`);
  }catch(err){
    console.warn(`No se pudo cargar ${path}`, err);
  }
  return null;
}

function ensureLayerDetached(layer){
  try{
    if(layer && map?.hasLayer?.(layer)) map.removeLayer(layer);
  }catch(_){/* noop */}
}

async function bootExtraLayers(){
  const configs = [
    { path:"capas/comunidades.js", keys:["CAPA_COMUNIDADES","capaComunidades","comunidadesLayer","comunidadesGeojson","comunidades","CAPA_comunidades"], name:"Comunidades (GeoJSON)", style:commStyle },
    { path:"capas/derecho_via.js", keys:["CAPA_DERECHO_VIA","capaDerechoVia","derechoViaLayer","derechoViaGeojson","derecho_via","derechoVia"], name:"Derecho de v√≠a", style:viaStyle }
  ];
  for(const cfg of configs){
    const payload = await loadExternalGeoJSON(cfg.path, cfg.keys);
    if(!payload) continue;
    try{
      let layer = null;
      if(payload.kind === "layer"){
        layer = payload.value;
      }else if(payload.kind === "data" && payload.value){
        layer = L.geoJSON(payload.value, { style: cfg.style });
      }
      if(!layer) continue;
      ensureLayerDetached(layer);
      layersCtl.addOverlay(layer, cfg.name);
    }catch(err){
      console.warn(`No se pudo agregar la capa ${cfg.name}`, err);
    }
  }
}

const modalBack = document.getElementById("modalListBack");
const modalObs = document.getElementById("modalObsBack");

function showModal(backdrop){ if(backdrop) backdrop.classList.add("show"); }
function hideModal(backdrop){ if(backdrop) backdrop.classList.remove("show"); }
[modalBack, modalObs].forEach(backdrop=>{
  backdrop?.addEventListener("click", (e)=>{ if(e.target === backdrop) hideModal(backdrop); });
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){ hideModal(modalBack); hideModal(modalObs); }
});

/* Handlers para botones de cabecera */
[
  ["btnLista", ()=> showModal(modalBack)],
  ["btnObs", async ()=>{ showModal(modalObs); await loadObserved(true); }]
].forEach(([id, handler])=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener("click", handler);
});

/** ====== GEOLOCALIZACI√ìN (bot√≥n abajo-izquierda) ====== **/
let locateMarker = null, locateCircle = null;
document.getElementById('btnLocate').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert("La geolocalizaci√≥n no est√° disponible en este navegador."); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude, acc = pos.coords.accuracy||0;
    const latlng = [lat, lon];
    if(!locateMarker){
      locateMarker = L.marker(latlng, { title:"Tu ubicaci√≥n" }).addTo(map);
      locateCircle = L.circle(latlng, { radius: acc, color:"#555", fillOpacity:0.10 }).addTo(map);
    }else{
      locateMarker.setLatLng(latlng);
      locateCircle.setLatLng(latlng).setRadius(acc);
    }
    map.fitBounds(L.latLngBounds([latlng, latlng]).pad(0.05));
  }, (err)=>{
    alert("No se pudo obtener la ubicaci√≥n: " + (err.message||""));
  }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
});

/** ====== CARGA DE DATOS ====== **/
async function loadAllPredios(options={}){
  const { fit = false } = options;
  const { data, error } = await client
    .from("cod_pred")
    .select("cod_prel,unir,comunidad,condicion,grupo,codigo_mtc,titular,tipo,geom,dni_ruc,contacto,responsable,fecha_elab,comentario_social,area,prog_ini,prog_fin,lado");
  if(error){ console.error(error); return null; }
  const rows = data||[];
  applyPredioRows(rows, { fitBounds: fit });
  savePrediosCache(rows);
  return rows;
}

function renderFeatures(rows, options={}){
  const { fitBounds=false } = options;
  capaPredio.clearLayers(); capaComunidad.clearLayers(); capaOtros.clearLayers();

  rows.forEach(p=>{
    if(!p.geom) return;
    const f = { type:"Feature", geometry:p.geom, properties:p };
    const layer = L.geoJSON(f, {
      style: ()=> styleByProps(p),
      onEachFeature: (_, lyr)=>{
        lyr.on("click", () => { selectedCodPrel = p.cod_prel; showGroup(p.unir); });
      }
    });
    if(isComunidad(p.tipo)) layer.addTo(capaComunidad);
    else if(isPredios(p.tipo)) layer.addTo(capaPredio);
    else layer.addTo(capaOtros);
  });

  const bounds = capaPredio.getLayers().length ? capaPredio.getBounds()
               : capaComunidad.getLayers().length ? capaComunidad.getBounds()
               : capaOtros.getLayers().length ? capaOtros.getBounds() : null;
  if(bounds && (fitBounds || !initialFitCompleted)){
    map.fitBounds(bounds);
    initialFitCompleted = true;
  }
}

function supportsStorage(){
  try{ return typeof localStorage !== "undefined"; }
  catch(_){ return false; }
}

function loadPrediosCache(){
  if(!supportsStorage()) return null;
  try{
    const raw = localStorage.getItem(PREDIOS_CACHE_KEY);
    if(!raw) return null;
    const payload = JSON.parse(raw);
    if(!payload?.rows || !Array.isArray(payload.rows)) return null;
    if(!payload.time || (Date.now() - payload.time) > PREDIOS_CACHE_TTL) return null;
    return payload.rows;
  }catch(err){ console.warn("Cache predios inv√°lida", err); return null; }
}

function savePrediosCache(rows){
  if(!supportsStorage()) return;
  try{
    localStorage.setItem(PREDIOS_CACHE_KEY, JSON.stringify({ time: Date.now(), rows }));
  }catch(err){ console.warn("No se pudo guardar la cache de predios", err); }
}

function populateCommunityOptions(rows){
  const selList = document.getElementById("listComunidad");
  if(!selList) return;
  const prev = selList.value;
  const comunidades = [...new Set((rows||[]).map(d=>d.comunidad).filter(Boolean))]
    .sort((a,b)=>a.localeCompare(b, "es", { sensitivity:"base" }));
  selList.innerHTML = '<option value="">‚Äî Selecciona ‚Äî</option>';
  comunidades.forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v;
    selList.appendChild(o);
  });
  if(prev && comunidades.includes(prev)) selList.value = prev;
}

function applyPredioRows(rows, options={}){
  const { fitBounds=false } = options;
  cachedPredios = Array.isArray(rows) ? rows : [];
  cachedPrediosMap = new Map(cachedPredios.map(r=>[r.cod_prel, r]));
  renderFeatures(cachedPredios, { fitBounds });
  populateCommunityOptions(cachedPredios);
  if(currentUnirId) highlightGroup(currentUnirId, false);
}

/** ====== DESTACAR GRUPO (UNIR) ====== **/
function highlightGroup(unirId, zoomTo=true){
  let groupBounds = null;
  const restyle = (grp)=>{
    grp.eachLayer(l=>{
      const props = l.feature?.properties;
      const setLayer = (ly, pr)=>{
        const match = pr.unir === unirId;
        ly.setStyle( match ? hiStyle : styleByProps(pr) );
        if(match){ ly.bringToFront(); if(ly.getBounds){ groupBounds = groupBounds ? groupBounds.extend(ly.getBounds()) : ly.getBounds(); } }
      };
      if(props) setLayer(l, props);
      l.eachLayer?.((sub)=>{ if(sub.feature?.properties) setLayer(sub, sub.feature.properties); });
    });
  };
  [capaPredio, capaComunidad, capaOtros].forEach(restyle);
  if(groupBounds && zoomTo) map.fitBounds(groupBounds, { padding:[40,40], maxZoom:20 });
}

/** ====== UI PANEL ====== **/
const blockCommon  = document.getElementById("commonBlock");
const wrapAreas    = document.getElementById("areasWrap");
const listAreas    = document.getElementById("areasList");
const emptyHint    = document.getElementById("emptyHint");
const unionCount   = document.getElementById("unionCount");

function setText(id, val){ document.getElementById(id).textContent = val ?? ""; }

async function showGroup(unirId){
  const { data, error } = await client.from("cod_pred").select("*").eq("unir", unirId);
  if(error || !data?.length){ return; }

  currentUnirId = unirId;
  highlightGroup(unirId, true);
  unionCount.textContent = `Se unen: ${data.length} ${data.length===1?'c√≥digo':'c√≥digos'}`;

  const c = data[0];

  blockCommon.style.display = "";
  wrapAreas.style.display = "";
  emptyHint.style.display = "none";

  setText("cm_mtc", c.codigo_mtc || "");
  setText("cm_titular", c.titular || "");
  setText("cm_dni", c.dni_ruc || "");
  setText("cm_contacto", c.contacto || "");
  setText("cm_comunidad", c.comunidad || "");
  setText("cm_condicion", c.condicion || "");
  setText("cm_tipo", (c.tipo||"predios"));
  setText("cm_grupo", c.grupo || "");

  // Tarjetas con edici√≥n √öNICA de comentario_social
  listAreas.innerHTML = "";
  (data||[]).forEach(p=>{
    const hasCom = hasSocial(p);
    const card = document.createElement("div");
    card.className = "area-card" + (hasCom ? " has-social" : "");
    card.setAttribute("data-cod", p.cod_prel);
    const cs = p.comentario_social ?? "";
    card.innerHTML = `
      <h4>${p.cod_prel}</h4>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><b>√Årea:</b> ${p.area ?? ""}</div>
        <div><b>Prog:</b> ${p.prog_ini ?? ""} - ${p.prog_fin ?? ""}</div>
      </div>
      <div style="margin:8px 0;"><b>Lado:</b> ${p.lado ?? ""}</div>

      <div style="margin-top:6px">
        <div class="label">Comentario social (editable)</div>
        <textarea rows="3" data-for="${p.cod_prel}" placeholder="A√±adir comentario social‚Ä¶">${cs}</textarea>
        <div class="area-actions" style="margin-top:8px">
          <button class="pill" data-cod="${p.cod_prel}" data-action="focus">Enfocar</button>
          <button class="pill" data-cod="${p.cod_prel}" data-action="save_cs">Guardar comentario</button>
        </div>
      </div>
    `;
    listAreas.appendChild(card);
  });

  listAreas.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      const cod = e.currentTarget.dataset.cod;
      const action = e.currentTarget.dataset.action;
      if(action==="focus"){ selectedCodPrel = cod; focusByCodPrel(cod); highlightGroup(currentUnirId, false); }
      if(action==="save_cs"){
        const ta = listAreas.querySelector(`textarea[data-for="${cod}"]`);
        const val = (ta?.value||"").trim();
        const { error:err } = await client.from("cod_pred").update({ comentario_social: (val===""? null : val) }).eq("cod_prel", cod);
        if(err){ alert("‚ùå Error al guardar comentario: "+err.message); return; }
        alert("‚úÖ Comentario guardado");
        await loadAllPredios();
        await showGroup(currentUnirId);
      }
    });
  });
}

function focusByCodPrel(cod){
  let found = null;
  [capaPredio, capaComunidad, capaOtros].forEach(group=>{
    group.eachLayer(l=>{
      if(l.feature?.properties?.cod_prel === cod) found = l;
      l.eachLayer?.((sub)=>{ if(sub.feature?.properties?.cod_prel === cod) found = sub; });
    });
  });
  if(found){
    const b = found.getBounds?.();
    if(b) map.fitBounds(b, { maxZoom: 20, padding:[40,40] });
  }
}

/** ====== BUSCADOR (cod_prel, cod_mtc, titular, prog_ini) ====== **/
const searchBox = document.getElementById("searchBox");
const suggestions = document.getElementById("suggestions");
let debounceTimer = null;

searchBox.addEventListener("input", (e)=>{
  const q = e.target.value.trim();
  clearTimeout(debounceTimer);
  if(q.length < 2){ suggestions.classList.remove("active"); suggestions.innerHTML=""; return; }
  debounceTimer = setTimeout(()=> runSuggest(q), 250);
});
searchBox.addEventListener("blur", ()=> setTimeout(()=>{ suggestions.classList.remove("active"); }, 150));

async function runSuggest(q){
  const { data, error } = await client.from("cod_pred")
    .select("cod_prel,codigo_mtc,unir,titular,prog_ini")
    .or(`cod_prel.ilike.%${q}%,codigo_mtc.ilike.%${q}%,titular.ilike.%${q}%,prog_ini.ilike.%${q}%`)
    .limit(12);
  if(error){ console.error(error); return; }
  suggestions.innerHTML = "";
  (data||[]).forEach(r=>{
    const tit = (r.titular||"").toString();
    const titCut = tit.length>60 ? tit.slice(0,57)+'‚Ä¶' : tit;
    const row = document.createElement("div");
    row.innerHTML = `<b>${r.cod_prel}</b> ‚Äî MTC: ${r.codigo_mtc ?? "‚Äî"} ‚Äî <span class="muted">prog_ini: ${r.prog_ini??"‚Äî"}</span><br><span class="muted">${titCut}</span>`;
    row.onclick = ()=>{ suggestions.classList.remove("active"); showGroup(r.unir); };
    suggestions.appendChild(row);
  });
  suggestions.classList.add("active");
}

/** ====== MODAL LISTA POR COMUNIDAD ====== **/
const btnCloseList = document.getElementById("btnCloseList");
const btnLoadList = document.getElementById("btnLoadList");
const listComunidad = document.getElementById("listComunidad");
const listFilter = document.getElementById("listFilter");
const tblList = document.getElementById("tblList").querySelector("tbody");
const btnExportList = document.getElementById("btnExportList");

btnCloseList.addEventListener("click", ()=>{ hideModal(modalBack); });

btnLoadList.addEventListener("click", ()=>{
  const com = listComunidad.value;
  if(!com){ alert("Selecciona una comunidad"); return; }
  if(!cachedPredios.length){
    alert("Los predios a√∫n se est√°n cargando. Intenta nuevamente en unos segundos.");
    return;
  }
  const rows = cachedPredios
    .filter(p=>p.comunidad === com)
    .map(p=>(
      {
        comunidad:p.comunidad,
        codigo_mtc:p.codigo_mtc,
        cod_prel:p.cod_prel,
        titular:p.titular,
        prog_ini:p.prog_ini,
        unir:p.unir
      }
    ))
    .sort((a,b)=> (a.codigo_mtc||"").localeCompare(b.codigo_mtc||"", undefined, { numeric:true, sensitivity:"base" }));
  renderListTable(rows);
  listFilter.value = "";
});

listFilter.addEventListener("input", ()=>{
  const term = listFilter.value.trim().toLowerCase();
  const rows = tblList.querySelectorAll("tr");
  rows.forEach(tr=>{
    const txt = tr.innerText.toLowerCase();
    tr.style.display = txt.includes(term) ? "" : "none";
  });
});

function renderListTable(rows){
  if(!Array.isArray(rows) || rows.length===0){
    lastListRows = [];
    tblList.innerHTML = `<tr><td colspan="6" class="muted">Sin resultados.</td></tr>`;
    return;
  }
  lastListRows = rows.map(r=>({ ...r }));
  tblList.innerHTML = rows.map(r=>`
    <tr>
      <td>${esc(r.comunidad)}</td>
      <td>${esc(r.codigo_mtc||"")}</td>
      <td>${esc(r.cod_prel||"")}</td>
      <td>${esc(r.titular||"")}</td>
      <td>${esc(r.prog_ini||"")}</td>
      <td><button class="btn-small" data-unir="${r.unir}" data-cod="${esc(r.cod_prel)}">Seleccionar</button></td>
    </tr>
  `).join("");
}

// selecci√≥n desde la tabla
document.getElementById("tblList").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-unir]");
  if(!btn) return;
  const unir = Number(btn.getAttribute("data-unir"));
  const cod  = btn.getAttribute("data-cod");
  hideModal(modalBack);
  await showGroup(unir);
  selectedCodPrel = cod;
  focusByCodPrel(cod);
  highlightGroup(unir, false);
  setTimeout(()=>{
    const card = Array.from(document.querySelectorAll(".area-card")).find(el => el.getAttribute("data-cod") === cod);
    if(card){
      card.classList.add("flash");
      card.scrollIntoView({ behavior:"smooth", block:"center" });
      setTimeout(()=> card.classList.remove("flash"), 1200);
    }
  }, 300);
});

/** ====== MODAL OBSERVADOS ====== **/
const btnCloseObs = document.getElementById("btnCloseObs");
const btnReloadObs = document.getElementById("btnReloadObs");
const obsFilter = document.getElementById("obsFilter");
const tblObs = document.getElementById("tblObs").querySelector("tbody");
const btnExportObsXls = document.getElementById("btnExportObsXls");
const btnExportObsKml = document.getElementById("btnExportObsKml");

btnCloseObs.addEventListener("click", ()=>{ hideModal(modalObs); });
btnReloadObs.addEventListener("click", async ()=>{
  await loadAllPredios({ fit:false });
  await loadObserved(false);
});
obsFilter.addEventListener("input", ()=>{
  const term = obsFilter.value.trim().toLowerCase();
  const rows = tblObs.querySelectorAll("tr");
  rows.forEach(tr=>{
    const txt = tr.innerText.toLowerCase();
    tr.style.display = txt.includes(term) ? "" : "none";
  });
});

async function loadObserved(forceFetch=false){
  tblObs.innerHTML = `<tr><td colspan="7" class="muted">Cargando‚Ä¶</td></tr>`;
  if(forceFetch || !cachedPredios.length){
    await loadAllPredios({ fit: !initialFitCompleted });
  }
  if(!cachedPredios.length){
    tblObs.innerHTML = `<tr><td colspan="7" class="muted">Sin datos disponibles.</td></tr>`;
    lastObsRows = [];
    return;
  }
  const rows = cachedPredios
    .filter(hasSocial)
    .map(p=>(
      {
        comunidad:p.comunidad,
        codigo_mtc:p.codigo_mtc,
        cod_prel:p.cod_prel,
        titular:p.titular,
        unir:p.unir,
        prog_ini:p.prog_ini,
        comentario_social:p.comentario_social
      }
    ))
    .sort((a,b)=>{
      const byCom = (a.comunidad||"").localeCompare(b.comunidad||"", "es", { sensitivity:"base" });
      if(byCom !== 0) return byCom;
      return (a.cod_prel||"").localeCompare(b.cod_prel||"", undefined, { numeric:true, sensitivity:"base" });
    });
  renderObsTable(rows);
  obsFilter.value = "";
}

function renderObsTable(rows){
  if(!Array.isArray(rows) || rows.length===0){
    lastObsRows = [];
    tblObs.innerHTML = `<tr><td colspan="7" class="muted">No hay c√≥digos observados.</td></tr>`;
    return;
  }
  lastObsRows = rows.map(r=>({ ...r }));
  tblObs.innerHTML = rows.map(r=>`
    <tr>
      <td>${esc(r.comunidad)}</td>
      <td>${esc(r.codigo_mtc||"")}</td>
      <td>${esc(r.cod_prel||"")}</td>
      <td>${esc(r.titular||"")}</td>
      <td>${esc(r.prog_ini||"")}</td>
      <td>${esc(r.comentario_social||"")}</td>
      <td><button class="btn-small" data-unir="${r.unir}" data-cod="${esc(r.cod_prel)}">Seleccionar</button></td>
    </tr>
  `).join("");
}

function slugifyFilename(text){
  return (text??"").toString().trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "_")
    .replace(/^_+|_+$/g, "") || "datos";
}

function csvEscape(val){
  const str = (val??"").toString().replace(/\r?\n/g, " ");
  const escaped = str.replace(/"/g, '""');
  return /[";,]/.test(str) ? `"${escaped}"` : escaped;
}

function buildCsv(headers, rows){
  const head = headers.map(h=>csvEscape(h.label)).join(",");
  const body = rows.map(row=> headers.map(h=>{
    const value = typeof h.getter === "function" ? h.getter(row) : row[h.key];
    return csvEscape(value);
  }).join(",")).join("\r\n");
  return `\uFEFF${head}` + (body ? `\r\n${body}` : "");
}

function downloadBlob(filename, content, mime){
  const blob = new Blob([content], { type:mime });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); link.remove(); }, 0);
}

function xmlEscape(str){
  return (str??"").toString().replace(/[<>&"']/g, m=>({"<":"&lt;",">":"&gt;","&":"&amp;","\"":"&quot;","'":"&apos;"}[m]||m));
}

function coordsToString(coords){
  return coords.map(c=>{
    const lon = c[0]??0;
    const lat = c[1]??0;
    const alt = c[2]??0;
    return `${lon},${lat},${alt}`;
  }).join(" ");
}

function closeRing(ring){
  if(!ring?.length) return [];
  const first = ring[0];
  const last = ring[ring.length-1];
  if(first[0]===last[0] && first[1]===last[1]) return ring.slice();
  return [...ring, first];
}

function polygonToKml(coords){
  if(!Array.isArray(coords) || !coords.length) return "";
  return `<Polygon>` + coords.map((ring, idx)=>{
    const points = coordsToString(closeRing(ring));
    if(!points) return "";
    const tag = idx===0 ? "outerBoundaryIs" : "innerBoundaryIs";
    return `<${tag}><LinearRing><coordinates>${points}</coordinates></LinearRing></${tag}>`;
  }).join("") + `</Polygon>`;
}

function lineStringToKml(coords){
  if(!Array.isArray(coords) || !coords.length) return "";
  return `<LineString><coordinates>${coordsToString(coords)}</coordinates></LineString>`;
}

function geometryToKml(geom){
  if(!geom) return "";
  const type = geom.type;
  const coords = geom.coordinates;
  switch(type){
    case "Point":
      return `<Point><coordinates>${coordsToString([coords])}</coordinates></Point>`;
    case "MultiPoint":
      return `<MultiGeometry>${coords.map(pt=>`<Point><coordinates>${coordsToString([pt])}</coordinates></Point>`).join("")}</MultiGeometry>`;
    case "LineString":
      return lineStringToKml(coords);
    case "MultiLineString":
      return `<MultiGeometry>${coords.map(line=>lineStringToKml(line)).filter(Boolean).join("")}</MultiGeometry>`;
    case "Polygon":
      return polygonToKml(coords);
    case "MultiPolygon":
      return `<MultiGeometry>${coords.map(poly=>polygonToKml(poly)).filter(Boolean).join("")}</MultiGeometry>`;
    case "GeometryCollection":
      return `<MultiGeometry>${(geom.geometries||[]).map(g=>geometryToKml(g)).filter(Boolean).join("")}</MultiGeometry>`;
    default:
      return "";
  }
}

function wrapCdata(text){
  return (text??"").replace(/]]>/g, "]]]><![CDATA[>");
}

function buildObservedKml(rows){
  const placemarks = rows.map(row=>{
    const base = cachedPrediosMap.get(row.cod_prel);
    const geom = base?.geom;
    const geomMarkup = geometryToKml(geom);
    if(!geomMarkup) return "";
    const description = [
      row.comunidad ? `<p><strong>Comunidad:</strong> ${esc(row.comunidad)}</p>` : "",
      row.codigo_mtc ? `<p><strong>C√≥digo MTC:</strong> ${esc(row.codigo_mtc)}</p>` : "",
      row.prog_ini ? `<p><strong>prog_ini:</strong> ${esc(row.prog_ini)}</p>` : "",
      row.comentario_social ? `<p><strong>Comentario social:</strong> ${esc(row.comentario_social)}</p>` : ""
    ].join("");
    const extended = `
      <ExtendedData>
        <Data name="comunidad"><value>${xmlEscape(row.comunidad||"")}</value></Data>
        <Data name="codigo_mtc"><value>${xmlEscape(row.codigo_mtc||"")}</value></Data>
        <Data name="cod_prel"><value>${xmlEscape(row.cod_prel||"")}</value></Data>
        <Data name="prog_ini"><value>${xmlEscape(row.prog_ini||"")}</value></Data>
        <Data name="comentario_social"><value>${xmlEscape(row.comentario_social||"")}</value></Data>
      </ExtendedData>`;
    return `<Placemark>
      <name>${xmlEscape(row.cod_prel||"Sin c√≥digo")}</name>
      ${extended}
      <description><![CDATA[${wrapCdata(description)}]]></description>
      ${geomMarkup}
    </Placemark>`;
  }).filter(Boolean).join("\n    ");
  if(!placemarks) return "";
  return `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n  <Document>\n    ${placemarks}\n  </Document>\n</kml>`;
}

btnExportList?.addEventListener("click", ()=>{
  if(!lastListRows.length){
    alert("Genera primero la lista por comunidad.");
    return;
  }
  const headers = [
    { label:"Comunidad", key:"comunidad" },
    { label:"C√≥digo MTC", key:"codigo_mtc" },
    { label:"cod_prel", key:"cod_prel" },
    { label:"Titular", key:"titular" },
    { label:"prog_ini", key:"prog_ini" }
  ];
  const csv = buildCsv(headers, lastListRows);
  const slug = slugifyFilename(listComunidad.value || "comunidad");
  downloadBlob(`lista_${slug}.csv`, csv, "text/csv;charset=utf-8;");
});

btnExportObsXls?.addEventListener("click", ()=>{
  if(!lastObsRows.length){
    alert("No hay observados para exportar.");
    return;
  }
  const headers = [
    { label:"Comunidad", key:"comunidad" },
    { label:"C√≥digo MTC", key:"codigo_mtc" },
    { label:"cod_prel", key:"cod_prel" },
    { label:"Titular", key:"titular" },
    { label:"prog_ini", key:"prog_ini" },
    { label:"Comentario social", key:"comentario_social" }
  ];
  const csv = buildCsv(headers, lastObsRows);
  downloadBlob("observados.csv", csv, "text/csv;charset=utf-8;");
});

btnExportObsKml?.addEventListener("click", ()=>{
  if(!lastObsRows.length){
    alert("No hay observados para exportar.");
    return;
  }
  const kml = buildObservedKml(lastObsRows);
  if(!kml){
    alert("No se pudo generar el archivo KML.");
    return;
  }
  downloadBlob("observados.kml", kml, "application/vnd.google-earth.kml+xml");
});

// selecci√≥n desde observados
document.getElementById("tblObs").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-unir]");
  if(!btn) return;
  const unir = Number(btn.getAttribute("data-unir"));
  const cod  = btn.getAttribute("data-cod");
  hideModal(modalObs);
  await showGroup(unir);
  selectedCodPrel = cod;
  focusByCodPrel(cod);
  highlightGroup(unir, false);
  setTimeout(()=>{
    const card = Array.from(document.querySelectorAll(".area-card")).find(el => el.getAttribute("data-cod") === cod);
    if(card){
      card.classList.add("flash");
      card.scrollIntoView({ behavior:"smooth", block:"center" });
      setTimeout(()=> card.classList.remove("flash"), 1200);
    }
  }, 300);
});

/** ====== RESIZER (solo PC) ====== **/
(function initGutter(){
  const left = document.getElementById("leftPane");
  const gutter = document.getElementById("gutter");
  let dragging=false, startX=0, startLeft=0;
  const isMobile = ()=> window.matchMedia("(max-width: 900px)").matches;
  gutter.addEventListener("mousedown",(e)=>{
    if(isMobile()) return;
    dragging=true; startX=e.clientX; startLeft=left.getBoundingClientRect().width;
    document.body.style.userSelect="none";
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging || isMobile()) return;
    const dx = e.clientX - startX;
    const newW = Math.max(280, Math.min(window.innerWidth-280, startLeft + dx));
    const percent = (newW / window.innerWidth) * 100;
    left.style.flexBasis = percent + "%";
    setTimeout(()=> map.invalidateSize(), 0);
  });
  window.addEventListener("mouseup",()=>{ dragging=false; document.body.style.userSelect=""; });
  window.addEventListener("resize", ()=> setTimeout(()=> map.invalidateSize(), 200));
})();

/** ====== INIT ====== **/
(async function init(){
  populateCommunityOptions([]);
  const cached = loadPrediosCache();
  if(Array.isArray(cached) && cached.length){
    initialFitCompleted = false;
    applyPredioRows(cached, { fitBounds:true });
  }
  await bootExtraLayers();
  await loadAllPredios({ fit: !initialFitCompleted });
})();
</script>
</body>
</html>
